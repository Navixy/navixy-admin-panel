<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style type="text/css">
        body {
            margin: 0;
        }
        @media print {
            html, body {
                height: 99%;
            }
        }
    </style>

    <script src="../libs/pdf/pdf.js"></script>
    <script src="../libs/jquery/jQuery.js"></script>
    <script src="../libs/jquery/jquery-barcode.js"></script>

</head>
<body>

<canvas id="canvas" style="width:100mm; height:71mm"></canvas>

<script id="script">

    ready = false;
    someError = false;

    var _url = ['..', '/', 'stickers', '/', getParameterByName('equip_id') || 'no_equip' , '.pdf'].join(''),
        _scale = 10,
        _width = 100,
        _height = 72,
        _value = getParameterByName('imei') || null,
        _iccid = getParameterByName('iccid') || 0,
        _barType = 'code128',
        _iccid_url = 'iccid.png';

    PDFJS.workerSrc = '../libs/pdf/pdf.worker.js';
    PDFJS.getDocument(_url).then(getPdf, pdfError);

    function pdfError() {
        someError = true;
    }

    function getPdfPage (page) {
        var viewPort = page.getViewport(_scale),
            canvas = preparePdfCanvas(viewPort),
            context = canvas.getContext('2d'),
            renderOptions = {
                canvasContext: context,
                viewport: viewPort
            };

        page.render(renderOptions).then(renderBarcode);
    }

    function getPdf (pdf) {
        pdf.getPage(1).then(getPdfPage);
    }

    function renderBarcode() {
        var canvas = document.getElementById('canvas'),
            context = canvas.getContext('2d');


        if (_value) {
            $(canvas).barcode(_value, _barType, prepareIMEIConfig(canvas));

            if (_iccid * 1) {
                var imageObj = new Image();

                imageObj.onload = function() {
                    context.drawImage(imageObj,
                            0, 0,
                            540, 160,
                            1615, 1230,
                            1090, 323
                    );
                    ready = true;
                };

                imageObj.src = _iccid_url;
            }
        }
    }

    function preparePdfCanvas(viewPort) {
        var canvas = document.getElementById('canvas');

        canvas.height = viewPort.height;
        canvas.width = viewPort.width;

        return canvas;
    }

    function sizeConvert (canvas, mm) {
        return canvas.width / _width * mm;
    }

    function prepareIMEIConfig (canvas) {
        return {
            output: 'canvas',
            bgColor: '#FFFFFF',
            color: '#000000',
            barWidth: 8,
            barHeight: 200,
            posX: 1560,
            posY: 1600,
            resultWidth: 1200,
            fontSize: 70,
            prefix: 'IMEI: ',
            font: [80, 'px Arial'].join('')
        }
    }

    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);

        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
</script>
</html>
