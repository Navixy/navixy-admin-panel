<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style type="text/css">
        body {
            margin: 0;
        }
        @media print {
            html, body {
                height: 99%;
            }
        }
    </style>

    <script src="../libs/pdf/pdf.js"></script>
    <script src="../libs/jquery/jQuery.js"></script>
    <script src="../libs/jquery/jquery-barcode.js"></script>

</head>
<body>

<canvas id="canvas" style="width:100mm; height:71mm"></canvas>

<script id="script">

    ready = false;
    someError = false;

    var _url = ['..', '/', 'stickers', '/', getParameterByName('equip_id') || 'no_equip' , '.pdf'].join(''),
        _scale = 10,
        _width = 100,
        _height = 72,
        _value = getParameterByName('imei') || null,
        _iccid = getParameterByName('iccid') || null,
        _barType = 'code128';

    PDFJS.getDocument(_url).then(getPdf, pdfError);

    function pdfError() {
        someError = true;
    }

    function getPdfPage (page) {
        var viewPort = page.getViewport(_scale),
            canvas = preparePdfCanvas(viewPort),
            context = canvas.getContext('2d'),
            imeiOptions = prepareIMEIConfig(canvas),
            iccidOptions = prepareICCIDConfig(canvas),
            renderOptions = {
                canvasContext: context,
                viewport: viewPort
            };

        page.render(renderOptions);

        if (_value) {
            setTimeout(function () {
                $(canvas).barcode(_value, _barType, imeiOptions);

                if (_iccid) {
                    $(canvas).barcode(_iccid, _barType, iccidOptions);
                }

                ready = true;
            }, 500);
        } else {
            someError = true;
        }
    }

    function getPdf (pdf) {
        pdf.getPage(1).then(getPdfPage);
    }

    function preparePdfCanvas(viewPort) {
        var canvas = document.getElementById('canvas');

        canvas.height = viewPort.height;
        canvas.width = viewPort.width;

        return canvas;
    }

    function sizeConvert (canvas, mm) {
        return canvas.width / _width * mm;
    }

    function prepareIMEIConfig (canvas) {
        return {
            output: 'canvas',
            bgColor: '#FFFFFF',
            color: '#000000',
            barWidth: sizeConvert(canvas, 0.3),
            barHeight: sizeConvert(canvas, 5),
            posX: sizeConvert(canvas, 55),
            posY: sizeConvert(canvas, 60),
            fontSize: sizeConvert(canvas, 2),
            prefix: 'IMEI: ',
            font: [sizeConvert(canvas, 1.8), 'px Arial'].join('')
        }
    }

    function prepareICCIDConfig (canvas) {
        return {
            output: 'canvas',
            bgColor: '#FFFFFF',
            color: '#000000',
            barWidth: sizeConvert(canvas, 0.25),
            barHeight: sizeConvert(canvas, 4),
            posX: sizeConvert(canvas, 56),
            posY: sizeConvert(canvas, 52),
            fontSize: sizeConvert(canvas, 2),
            prefix: 'ICCID: ',
            font: [sizeConvert(canvas, 1.8), 'px Arial'].join('')
        }
    }

    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);

        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
</script>
</html>
